# **ğŸš€ Working with Databases in PowerShell (MS SQL Server)**

Yes! **PowerShell** can interact with **Microsoft SQL Server** to **query, insert, update, delete, and manage databases**. Using **ADO.NET, Invoke-Sqlcmd, and dbatools**, you can automate **database tasks, backups, and data processing**.

---

## **ğŸ“Œ 1. Connecting to SQL Server from PowerShell**

There are **two main ways** to connect PowerShell to SQL Server:

1ï¸âƒ£ **Using `Invoke-Sqlcmd`** (simpler, requires SQL Server PowerShell Module)  
2ï¸âƒ£ **Using ADO.NET (`System.Data.SqlClient`)** (native, works everywhere)

---

## **ğŸ“Œ 2. Using `Invoke-Sqlcmd` for Simple Queries**

### **ğŸ”¹ Install the SQL Server Module**

Before using `Invoke-Sqlcmd`, install the **SQL Server PowerShell Module**:

```powershell
Install-Module -Name SqlServer -Scope CurrentUser
```

âœ… **Ensures PowerShell can interact with SQL Server.**

---

### **ğŸ”¹ Query a Database (`SELECT` Query)**

```powershell
Invoke-Sqlcmd -ServerInstance "localhost" -Database "TestDB" -Query "SELECT * FROM Employees"
```

âœ… Retrieves **all records from the Employees table**.

---

### **ğŸ”¹ Running Queries with Variables**

```powershell
$server = "localhost"
$db = "TestDB"
$query = "SELECT * FROM Employees WHERE Department = 'IT'"

Invoke-Sqlcmd -ServerInstance $server -Database $db -Query $query
```

âœ… Filters **Employees in IT Department**.

---

### **ğŸ”¹ Insert Data into SQL Server**

```powershell
Invoke-Sqlcmd -ServerInstance "localhost" -Database "TestDB" -Query "
    INSERT INTO Employees (Name, Age, Department)
    VALUES ('Alice', 30, 'HR')
"
```

âœ… Adds **a new employee (Alice) into HR**.

---

### **ğŸ”¹ Update a Record in SQL Server**

```powershell
Invoke-Sqlcmd -ServerInstance "localhost" -Database "TestDB" -Query "
    UPDATE Employees SET Age = 31 WHERE Name = 'Alice'
"
```

âœ… Updates **Aliceâ€™s age to 31**.

---

### **ğŸ”¹ Delete a Record from SQL Server**

```powershell
Invoke-Sqlcmd -ServerInstance "localhost" -Database "TestDB" -Query "
    DELETE FROM Employees WHERE Name = 'Alice'
"
```

âœ… **Deletes Aliceâ€™s record** from Employees.

---

## **ğŸ“Œ 3. Using ADO.NET for SQL Server Connection**

If `Invoke-Sqlcmd` **isnâ€™t available**, use **ADO.NET (`System.Data.SqlClient`)**, which works **natively** in PowerShell.

---

### **ğŸ”¹ Connecting to SQL Server Using ADO.NET**

```powershell
$server = "localhost"
$database = "TestDB"
$connString = "Server=$server;Database=$database;Integrated Security=True"

$conn = New-Object System.Data.SqlClient.SqlConnection
$conn.ConnectionString = $connString
$conn.Open()

Write-Output "Connected to $database on $server"
$conn.Close()
```

âœ… **Establishes a connection** to SQL Server.

---

### **ğŸ”¹ Running a SELECT Query with ADO.NET**

```powershell
$server = "localhost"
$database = "TestDB"
$connString = "Server=$server;Database=$database;Integrated Security=True"

$conn = New-Object System.Data.SqlClient.SqlConnection
$conn.ConnectionString = $connString
$conn.Open()

$cmd = $conn.CreateCommand()
$cmd.CommandText = "SELECT * FROM Employees"

$reader = $cmd.ExecuteReader()
$table = New-Object System.Data.DataTable
$table.Load($reader)

$conn.Close()

$table | Format-Table -AutoSize
```

âœ… Retrieves **all Employees and formats output nicely**.

---

### **ğŸ”¹ Running an INSERT Query with ADO.NET**

```powershell
$conn = New-Object System.Data.SqlClient.SqlConnection
$conn.ConnectionString = "Server=localhost;Database=TestDB;Integrated Security=True"
$conn.Open()

$cmd = $conn.CreateCommand()
$cmd.CommandText = "INSERT INTO Employees (Name, Age, Department) VALUES ('Bob', 35, 'Finance')"
$cmd.ExecuteNonQuery()

$conn.Close()
Write-Output "Record inserted successfully!"
```

âœ… **Inserts a new employee (Bob) into Finance**.

---

### **ğŸ”¹ Running a Parameterized Query (Safer SQL Execution)**

```powershell
$conn = New-Object System.Data.SqlClient.SqlConnection
$conn.ConnectionString = "Server=localhost;Database=TestDB;Integrated Security=True"
$conn.Open()

$cmd = $conn.CreateCommand()
$cmd.CommandText = "INSERT INTO Employees (Name, Age, Department) VALUES (@Name, @Age, @Department)"

$cmd.Parameters.Add((New-Object Data.SqlClient.SqlParameter("@Name", "Charlie")))
$cmd.Parameters.Add((New-Object Data.SqlClient.SqlParameter("@Age", 40)))
$cmd.Parameters.Add((New-Object Data.SqlClient.SqlParameter("@Department", "Marketing")))

$cmd.ExecuteNonQuery()
$conn.Close()

Write-Output "Charlie added successfully!"
```

âœ… Uses **parameters to prevent SQL injection**.

---

## **ğŸ“Œ 4. Managing SQL Server with `dbatools` Module**

The **`dbatools`** module simplifies SQL Server administration using PowerShell.

### **ğŸ”¹ Install `dbatools` Module**

```powershell
Install-Module dbatools -Scope CurrentUser
```

### **ğŸ”¹ Get SQL Server Instances**

```powershell
Get-DbaInstance -ComputerName "localhost"
```

âœ… Lists **all running SQL Server instances**.

---

### **ğŸ”¹ Get Database List**

```powershell
Get-DbaDatabase -SqlInstance "localhost"
```

âœ… Lists **all databases**.

---

### **ğŸ”¹ Backup a SQL Database**

```powershell
Backup-DbaDatabase -SqlInstance "localhost" -Database "TestDB" -Path "C:\Backups\TestDB.bak"
```

âœ… Creates **a full backup** of `TestDB`.

---

### **ğŸ”¹ Restore a SQL Database**

```powershell
Restore-DbaDatabase -SqlInstance "localhost" -Database "TestDB" -Path "C:\Backups\TestDB.bak"
```

âœ… Restores **the database from a backup file**.

---

### **ğŸ”¹ Check SQL Server Performance**

```powershell
Get-DbaCpuUsage -SqlInstance "localhost"
```

âœ… Monitors **CPU usage** for SQL Server.

---

## **ğŸ“Œ 5. Automating SQL Tasks with PowerShell**

### **ğŸ”¹ Run Daily Backup Automatically**

Create a **PowerShell script (`backup.ps1`)**:

```powershell
Backup-DbaDatabase -SqlInstance "localhost" -Database "TestDB" -Path "C:\Backups\TestDB_$(Get-Date -Format yyyyMMdd).bak"
```

âœ… Saves **daily backups**.

### **ğŸ”¹ Schedule the Script Using Task Scheduler**

1ï¸âƒ£ Open **Task Scheduler (`taskschd.msc`)**  
2ï¸âƒ£ Click **"Create Basic Task"**  
3ï¸âƒ£ Set **Daily/Weekly Schedule**  
4ï¸âƒ£ Set Action â†’ **"Start a Program"**  
5ï¸âƒ£ Use this as the program:

```powershell
powershell.exe -ExecutionPolicy Bypass -File "C:\Scripts\backup.ps1"
```

âœ… Automates **daily backups of SQL Server**.

---

## **ğŸ“Œ 6. Best Practices for PowerShell & SQL Server**

âœ… **Use `Invoke-Sqlcmd` for quick queries** â†’ Easy and fast.  
âœ… **Use ADO.NET for complex queries** â†’ Works natively with PowerShell.  
âœ… **Use `dbatools` for server management** â†’ Backup, restore, performance checks.  
âœ… **Always use parameterized queries** â†’ Prevents **SQL injection attacks**.  
âœ… **Automate backups & reports** â†’ Use **Task Scheduler for daily automation**.

---

## **ğŸ¯ Conclusion: Mastering PowerShell for SQL Server**

âœ… **Retrieve, insert, update, and delete records** using PowerShell  
âœ… **Use `Invoke-Sqlcmd` for simple database interactions**  
âœ… **Use ADO.NET for complex SQL queries & parameterized execution**  
âœ… **Manage SQL servers easily using `dbatools`**  
âœ… **Automate backups and maintenance tasks**
